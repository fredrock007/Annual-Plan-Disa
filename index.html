<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DISA Primary — Weekly Lesson Plan (Term 1)</title>

  <!-- ExcelJS for .xlsx generation (merged-cells + styling + image support) -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

  <style>
    :root{--ink:#111;--line:#111;--paper:#fff;--green:#93c47d;--grey:#e6e6e6;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:var(--ink);background:var(--paper);}

    .toolbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #ccc;padding:10px 12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar button{padding:6px 10px;cursor:pointer}
    .hint{font-size:12px;color:#444;margin-left:auto}

    .doc{max-width:1100px;margin:0 auto;padding:12px}
    .print-page{page-break-after:always;margin:0;padding:0}

    table.plan{width:100%;border-collapse:collapse;table-layout:fixed;font-size:14px}
    table.plan td, table.plan th{border:1.6px solid var(--line);padding:6px 8px;vertical-align:top;word-wrap:break-word;white-space:pre-wrap}

    .top-left{font-weight:700;letter-spacing:.2px;line-height:1.2}
    .top-mid{text-align:center;font-weight:700}
    .top-right{text-align:right;font-weight:700}

    .school-line{display:flex;flex-direction:column;align-items:center;gap:6px}
    .school-line img{height:46px;width:auto;display:block}
    .logo-note{font-size:11px;color:#666;display:none}
    .logo-missing .logo-note{display:block}

    .green{background:var(--green);font-weight:700;color:#fff;text-align:center}
    .section-title{font-weight:700;text-align:center}
    .grey{background:var(--grey)}
    .left-vertical{font-weight:700;text-align:center}
    .left-label{font-weight:700;text-align:center}
    .cell-small{font-size:13px}

    @media print{
      .toolbar{display:none !important}
      @page{margin:12mm}
      body.print-grade-active .print-page{display:none !important}
      body.print-grade-active .print-page.print-grade-show{display:block !important}
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button type="button" onclick="printAll()">Print (All)</button>
    <button type="button" onclick="downloadPDFAll()">Download PDF (All)</button>

    <span style="width:10px"></span>

    <button type="button" onclick="downloadPDFGrade('Grade 5')">Download PDF — Grade 5</button>
    <button type="button" onclick="downloadPDFGrade('Grade 6')">Download PDF — Grade 6</button>
    <button type="button" onclick="downloadPDFGrade('Grade 7')">Download PDF — Grade 7</button>

    <span style="width:10px"></span>

    <button type="button" onclick="downloadXLSXGrade('Grade 5')">Download XLSX — Grade 5</button>
    <button type="button" onclick="downloadXLSXGrade('Grade 6')">Download XLSX — Grade 6</button>
    <button type="button" onclick="downloadXLSXGrade('Grade 7')">Download XLSX — Grade 7</button>

    <span class="hint">Clean PDF: in the print dialog, switch OFF "Headers and footers".</span>
  </div>

  <div class="doc" id="doc"></div>

  <script>
    // -------------------------
    // CONFIG
    // -------------------------
    const TERM_LABEL = 'Term 1';
    const TEACHER = 'Mr Samuels';

    // Logo file placed in the same folder as this page in your GitHub Pages repo
    // Must be an image (png/jpg).
    const LOGO_FILE = 'disa-logo.png';

    // Build an absolute URL for GitHub Pages (avoids path issues when hosted in subfolders)
    function logoURL(cacheBust){
      const u = new URL(LOGO_FILE, window.location.href);
      if(cacheBust) u.searchParams.set('v', String(Date.now()));
      return u.toString();
    }

    // -------------------------
    // TERM DATES + PUBLIC HOLIDAYS (South Africa)
    // Term 1: Wed 14 Jan 2026 – Fri 10 Apr 2026
    // - Good Friday: Fri 3 Apr
    // - Family Day: Mon 6 Apr
    // -------------------------

    const WEEKS = [
      { w:1,  dates:'14–16 January (Wed–Fri)' },
      { w:2,  dates:'19–23 January' },
      { w:3,  dates:'26–30 January' },
      { w:4,  dates:'2–6 February' },
      { w:5,  dates:'9–13 February' },
      { w:6,  dates:'16–20 February' },
      { w:7,  dates:'23–27 February' },
      { w:8,  dates:'2–6 March' },
      { w:9,  dates:'9–13 March' },
      { w:10, dates:'16–20 March' },
      { w:11, dates:'23–27 March' },
      { w:12, dates:'30 March–3 April (Good Friday: Fri 3 Apr)', holiday:'Good Friday (Fri 3 April) – no school' },
      { w:13, dates:'6–10 April (Family Day: Mon 6 Apr)', holiday:'Family Day (Mon 6 April) – no school' }
    ];

    // -------------------------
    // TOUCH TYPING (major component)
    // -------------------------

    const TT = {
      g5: [
        'Posture + finger placement (home row)',
        'Accuracy first (no looking)',
        'Common letter patterns + spacing',
        'Short sentences → short paragraphs',
        'End-term goal: consistent accuracy with basic paragraphs'
      ],
      g6: [
        'Home row automaticity + reach keys',
        'Accuracy + speed targets (WPM)',
        'Paragraph typing (editing discipline)',
        'Typing for productivity (docs + sheets)',
        'End-term goal: steady WPM with clean formatting'
      ],
      g7: [
        'Speed + accuracy targets (WPM + error-rate)',
        'Typing for coding (symbols, brackets, indentation)',
        'Document production (headings, bullets)',
        'Timed typing + exam readiness',
        'End-term goal: reliable typing under time pressure'
      ]
    };

    function typingFocus(week, gradeKey){
      const arr = TT[gradeKey];
      const idx = Math.min(arr.length - 1, Math.floor((week - 1) / 3));
      return arr[idx];
    }

    function typingIntro(week, gradeKey, short){
      const focus = typingFocus(week, gradeKey);
      return short
        ? 'Touch Typing Focus: ' + focus + ' (short warm-up + target)'
        : 'Touch Typing Focus: ' + focus + ' (baseline/target + technique)';
    }

    function checkShort(){ return 'Exit ticket: evidence (screenshot/link) + 1 sentence reflection.'; }
    function checkLong(){ return 'Checklist: login, file naming, typing accuracy, task completion.'; }

    // -------------------------
    // GRADE 5 (2 × 60 mins/week)
    // -------------------------

    function g5L1(week){
      if(week===1) return 'Windows login routine + file naming + touch typing: posture + home row accuracy drills.';
      if(week<=4) return 'Typing warm-up + application skills: basic formatting + save work neatly (evidence in folder).';
      if(week<=6) return 'Typing warm-up + Scratch intro: events + variables; build a tiny interactive scene.';
      if(week<=8) return 'Typing warm-up + robotics basics: IPO + simple LED/buzzer patterns (MakeCode).';
      if(week<=10) return 'Typing warm-up + mini PAT: choose a simple problem + plan + start building.';
      if(week<=11) return 'Typing warm-up + mini PAT build + add one new feature.';
      return 'Typing warm-up + revision/catch-up with clear evidence in portfolio.';
    }
    function g5L2(week){
      if(week===1) return 'Typing game (accuracy) + digital citizenship: safe passwords + device care.';
      if(week<=4) return 'Typing sentences + presentation task: 2–3 slides with headings, images, neat layout.';
      if(week<=6) return 'Typing paragraphs + Scratch task: IF decisions + short rubric.';
      if(week<=8) return 'Typing paragraphs + MakeCode: LED sequence or buzzer alarm (save link as evidence).';
      if(week<=10) return 'Typing paragraphs + mini PAT continue + testing checklist.';
      if(week<=11) return 'Typing timed challenge + mini showcase + peer feedback.';
      return 'Typing final check + end-of-term showcase + reflection.';
    }

    // -------------------------
    // GRADE 6 (2 × 60 mins/week)
    // -------------------------

    function g6L1(week){
      if(week===1) return 'Windows login mastery + typing baseline + rules for appropriate online use.';
      if(week<=3) return 'Typing warm-up + spreadsheets: data entry, formatting, clean table.';
      if(week<=4) return 'Typing warm-up + CAD accuracy task: copy a 2D drawing and save versions.';
      if(week<=6) return 'Typing warm-up + Scratch: conditions + collision logic; build a simple game mechanic.';
      if(week<=8) return 'Typing warm-up + robotics: outputs + inputs + DC motor intro (safety + control).';
      if(week<=10) return 'Typing warm-up + PAT: investigation + design + build prototype.';
      return 'Typing warm-up + revision/catch-up + extension feature.';
    }
    function g6L2(week){
      if(week===1) return 'Typing accuracy + e-communication basics (if available) + cyber safety.';
      if(week<=3) return 'Typing paragraphs + spreadsheet: chart task + short interpretation questions.';
      if(week<=4) return 'Typing paragraphs + CAD: label key features + export screenshot evidence.';
      if(week<=6) return 'Typing timed + Scratch: variables + IF for scoring or lives.';
      if(week<=8) return 'Typing timed + robotics: motor speed control using variables; simple test plan.';
      if(week<=10) return 'Typing timed + PAT: evaluate against requirements + improve + submit evidence.';
      return 'Typing final + reflection + Term 2 preview.';
    }

    // -------------------------
    // GRADE 7 (2 × 30 mins/week)
    // Blended strands: 35% Technology + 65% Coding & Robotics
    // -------------------------

    function g7TechLesson(week){
      if(week===1) return 'TECH (35% strand): Introduce systems thinking + safety. Explore simple mechanisms: levers (1st/2nd/3rd class) using classroom objects. Quick sketch of each lever in books.';
      if(week===2) return 'TECH (35% strand): Linkages + mechanical advantage (qualitative). Investigate everyday linkages (stapler, scissors, tongs). Short comparison: force in vs force out.';
      if(week===3) return 'TECH (35% strand): Hydraulics vs pneumatics. Mini practical: syringe + tubing demo (air vs water). Record observations; connect to force transfer.';
      if(week===4) return 'TECH (35% strand): Design brief for an Automated Safety System. Define specs + constraints; choose materials; plan mechanism + control.';
      if(week===5) return 'TECH (35% strand): Working drawings: quick 2D with dimensions; basic isometric sketch. Teacher models on Clevertouch; learners submit sketches.';
      if(week===6) return 'TECH (35% strand): Build phase 1: construct frame + lever/linkage (cardboard/wood/skewers) under safe tool rules. Test movement.';
      if(week===7) return 'TECH (35% strand): Build phase 2: add hydraulic/pneumatic actuation (syringes + tubing) OR controlled barrier mechanism. Iterate for strength + control.';
      if(week===8) return 'TECH (35% strand): Evaluate + improve: compare designs, list pros/cons, stability, usability. Add one improvement and justify it.';
      if(week===9) return 'TECH (35% strand): Communicate: team presentation + labelled drawings; demonstrate model; short reflection on safety technologies.';
      return 'TECH (integration only): 5-minute mechanism recap linked to current C&R task (sensors/robot motion).';
    }

    function g7CRLesson(week){
      if(week===1) return 'C&R (65% strand): Portfolio folders + typing baseline (WPM + accuracy) + symbols for coding ((), {}, [], :, ;). Short drill: type a bracket-heavy line correctly.';
      if(week===2) return 'C&R (65% strand): Application skill: clean document formatting (headings, bullets). Produce a 1-page Lab Rules + Safety sheet. Save PDF to portfolio.';
      if(week===3) return 'C&R (65% strand): Algorithms: flowchart basics + pseudocode. Create an algorithm for safe system start-up checklist.';
      if(week===4) return 'C&R (65% strand): Micro:bit / MakeCode: output (LED/buzzer) + variables. Build a warning signal pattern and save the share link.';
      if(week===5) return 'C&R (65% strand): Sensors: micro:bit input (light/temperature/buttons) or Spike sensor. Create threshold logic (if/else).';
      if(week===6) return 'C&R (65% strand): Robotics control: Spike or Sphero — movement + timing. Challenge: move to a target and stop accurately.';
      if(week===7) return 'C&R (65% strand): Combine: sensor → decision → action. Build a simple safety behaviour (alarm/light/barrier trigger).';
      if(week===8) return 'C&R (65% strand): Mini PAT build: Automated Safety System logic + evidence capture (photos/video/share links).';
      if(week===9) return 'C&R (65% strand): Mini PAT continue: testing checklist + improve reliability. Capture evidence.';
      if(week===10) return 'C&R (65% strand): Mini PAT finalise + short theory quiz (algorithms, IF, safety, sensors).';
      if(week===11) return 'C&R (65% strand): Extension: 3D design a simple part (housing/bracket) OR refine code readability + comments.';
      if(week===12) return 'C&R (65% strand): Public Holiday week: consolidate evidence; catch-up; optional typing speed test.';
      return 'C&R (65% strand): Final showcase + reflection: what improved (typing, design thinking, coding, robotics).';
    }

    function g7L1(week){
      const tt = 'Typing warm-up (3–5 min): ' + typingFocus(week,'g7') + '.';
      return tt + ' ' + g7TechLesson(week);
    }
    function g7L2(week){
      const tt = 'Typing warm-up (3–5 min): ' + typingFocus(week,'g7') + '.';
      return tt + ' ' + g7CRLesson(week);
    }

    // -------------------------
    // RESOURCES
    // -------------------------

    function resourcesCommon(){
      return 'PC lab, projector, typing tool, Scratch/MakeCode/Python as needed, worksheets, rubrics.';
    }

    function resourcesGrade7(){
      return [
        'Clevertouch interactive whiteboard (2 pens)',
        'Laptops (Windows), iPads',
        'Sphero BOLT (15+)',
        'LEGO Spike Education (4)',
        'micro:bit (20) + portable batteries (15)',
        '3D printers: Creality Hi + Ender-3 V3',
        'Small whiteboards (30)',
        'Technology materials (as per CAPS) + robotics consumables (school budget ±R80k)'
      ].join('; ');
    }

    function homeworkBase(mins){
      return mins + ' min typing practice + finish any incomplete class task.';
    }

    // -------------------------
    // SAFE HTML ESCAPE
    // -------------------------

    function escapeToHTML(s){
      const t = String(s == null ? '' : s);
      return t
        .split('&').join('&amp;')
        .split('<').join('&lt;')
        .split('>').join('&gt;')
        .split('"').join('&quot;')
        .split("'").join('&#39;')
        .split('\\n').join('<br>');
    }

    // -------------------------
    // GRADE BUILDER
    // -------------------------

    function buildGrade(opts){
      return {
        grade: opts.grade,
        timetable: opts.timetable,
        gradeKey: opts.gradeKey,
        subject: opts.subject,
        capsTopic: opts.capsTopic,
        lesson1Fn: opts.lesson1Fn,
        lesson2Fn: opts.lesson2Fn,
        resourcesFn: opts.resourcesFn,
        hwMins: opts.hwMins,
        weeks: WEEKS.map(w => ({
          w: w.w,
          dates: w.dates,
          term: TERM_LABEL,
          lesson1: { intro: typingIntro(w.w, opts.gradeKey, false), activities: opts.lesson1Fn(w.w), check: checkLong() },
          lesson2: { intro: typingIntro(w.w, opts.gradeKey, true),  activities: opts.lesson2Fn(w.w), check: checkShort() },
          integration: w.holiday ? 'Public Holiday: ' + w.holiday : 'Integration: language (instructions), maths (logic), digital citizenship, relevant subjects.',
          resources: opts.resourcesFn(w.w),
          homework: w.holiday ? homeworkBase(opts.hwMins) + ' (Note: ' + w.holiday + ')' : homeworkBase(opts.hwMins)
        }))
      };
    }

    const GRADES = [
      buildGrade({
        grade: 'Grade 5',
        timetable: '2 × 60-minute lessons per week',
        gradeKey: 'g5',
        subject: 'Coding & Robotics',
        capsTopic: 'Touch Typing (core) + Digital Foundations / Application Skills / Scratch / Robotics',
        lesson1Fn: g5L1,
        lesson2Fn: g5L2,
        resourcesFn: () => resourcesCommon(),
        hwMins: '5–10'
      }),
      buildGrade({
        grade: 'Grade 6',
        timetable: '2 × 60-minute lessons per week',
        gradeKey: 'g6',
        subject: 'Coding & Robotics',
        capsTopic: 'Touch Typing (core) + E-communication / Spreadsheets / CAD / Scratch / Robotics',
        lesson1Fn: g6L1,
        lesson2Fn: g6L2,
        resourcesFn: () => resourcesCommon(),
        hwMins: '10'
      }),
      buildGrade({
        grade: 'Grade 7',
        timetable: '2 × 30-minute lessons per week',
        gradeKey: 'g7',
        subject: 'Coding, Robotics & Technology',
        capsTopic: 'Touch Typing (major) + 35% Technology (Mechanical Systems & Control) + 65% Coding & Robotics',
        lesson1Fn: g7L1,
        lesson2Fn: g7L2,
        resourcesFn: () => resourcesGrade7(),
        hwMins: '5–10'
      })
    ];

    // -------------------------
    // RENDER (DOM-built)
    // -------------------------

    function el(tag, className, text){
      const node = document.createElement(tag);
      if(className) node.className = className;
      if(text !== undefined) node.textContent = text;
      return node;
    }

    function td(colspan, className, text){
      const cell = document.createElement('td');
      if(colspan) cell.colSpan = colspan;
      if(className) cell.className = className;
      if(text !== undefined) cell.textContent = text;
      return cell;
    }

    function addColgroup(tbl){
      const colgroup = document.createElement('colgroup');
      for(let i=0;i<14;i++){
        const c = document.createElement('col');
        c.style.width = '8%';
        colgroup.appendChild(c);
      }
      tbl.appendChild(colgroup);
    }

    function setHTML(cell, html){
      cell.innerHTML = html;
    }

    function buildPlanTable(grade, week){
      const tbl = document.createElement('table');
      tbl.className = 'plan';
      addColgroup(tbl);

      // Row 1
      let tr = document.createElement('tr');
      tr.appendChild(td(4,'top-left','INTERMEDIATE PHASE\nWEEKLY LESSON PLAN'));

      const mid = td(6,'top-mid');
      const schoolLine = el('div','school-line');
      const img = document.createElement('img');
      img.alt = 'DISA logo';
      img.src = logoURL(false);
      img.onerror = () => {
        schoolLine.classList.add('logo-missing');
        img.style.display = 'none';
      };
      const note = el('div','logo-note','(Logo missing: ensure disa-logo.png is in the same folder as index.html)');
      schoolLine.appendChild(img);
      schoolLine.appendChild(el('div',null,'DISA PRIMARY SCHOOL'));
      schoolLine.appendChild(note);
      mid.appendChild(schoolLine);

      tr.appendChild(mid);
      tr.appendChild(td(4,'top-right','SUBJECT: ' + grade.subject));
      tbl.appendChild(tr);

      // Row 2 (green headings)
      tr = document.createElement('tr');
      tr.appendChild(td(2,'green','Term:'));
      tr.appendChild(td(2,'green','Week:'));
      tr.appendChild(td(6,'green','Date:'));
      tr.appendChild(td(2,'green','Grade:'));
      tr.appendChild(td(2,'green','Teacher:'));
      tbl.appendChild(tr);

      // Row 3 (values)
      tr = document.createElement('tr');
      const termCell = td(2,'cell-small'); setHTML(termCell, escapeToHTML(week.term));
      tr.appendChild(termCell);
      tr.appendChild(td(2,'cell-small','Week ' + week.w));
      const dateCell = td(6,'cell-small'); setHTML(dateCell, escapeToHTML(week.dates));
      tr.appendChild(dateCell);
      const gCell = td(2,'cell-small'); setHTML(gCell, escapeToHTML(grade.grade));
      tr.appendChild(gCell);
      const tCell = td(2,'cell-small'); setHTML(tCell, escapeToHTML(TEACHER));
      tr.appendChild(tCell);
      tbl.appendChild(tr);

      // Row 4 (lesson headers)
      tr = document.createElement('tr');
      tr.appendChild(td(2,null,''));
      tr.appendChild(td(5,'section-title','LESSON 1'));
      tr.appendChild(td(7,'section-title','LESSON 2'));
      tbl.appendChild(tr);

      // Row 5 CAPS Topic
      tr = document.createElement('tr');
      const leftVert = td(1,'left-vertical','TEACHING AND\nLEARNING\nACTIVITIES');
      leftVert.rowSpan = 4;
      tr.appendChild(leftVert);
      tr.appendChild(td(1,'left-label','CAPS Topic'));

      const caps1 = td(5,'grey');
      setHTML(caps1, escapeToHTML(grade.capsTopic) + '<br><b>' + escapeToHTML(grade.grade) + '</b> — ' + escapeToHTML(grade.timetable));
      tr.appendChild(caps1);

      const caps2 = td(7,'grey');
      setHTML(caps2, escapeToHTML(grade.capsTopic) + '<br><b>' + escapeToHTML(grade.grade) + '</b> — ' + escapeToHTML(grade.timetable));
      tr.appendChild(caps2);
      tbl.appendChild(tr);

      // Row 6 Introduction
      tr = document.createElement('tr');
      tr.appendChild(td(1,'left-label','Introduction'));
      const intro1 = td(5); setHTML(intro1, escapeToHTML(week.lesson1.intro));
      const intro2 = td(7); setHTML(intro2, escapeToHTML(week.lesson2.intro));
      tr.appendChild(intro1);
      tr.appendChild(intro2);
      tbl.appendChild(tr);

      // Row 7 Activities
      tr = document.createElement('tr');
      tr.appendChild(td(1,'left-label','Activities'));
      const act1 = td(5); setHTML(act1, escapeToHTML(week.lesson1.activities));
      const act2 = td(7); setHTML(act2, escapeToHTML(week.lesson2.activities));
      tr.appendChild(act1);
      tr.appendChild(act2);
      tbl.appendChild(tr);

      // Row 8 Check for understanding
      tr = document.createElement('tr');
      tr.appendChild(td(1,'left-label','Check for\nunderstanding'));
      const chk1 = td(5); setHTML(chk1, escapeToHTML(week.lesson1.check));
      const chk2 = td(7); setHTML(chk2, escapeToHTML(week.lesson2.check));
      tr.appendChild(chk1);
      tr.appendChild(chk2);
      tbl.appendChild(tr);

      // Row 9 Integration
      tr = document.createElement('tr');
      tr.appendChild(td(2,'left-label','INTEGRATION'));
      const integ = td(12); setHTML(integ, escapeToHTML(week.integration));
      tr.appendChild(integ);
      tbl.appendChild(tr);

      // Row 10 Resources
      tr = document.createElement('tr');
      tr.appendChild(td(2,'left-label','RESOURCES'));
      const res = td(12); setHTML(res, escapeToHTML(week.resources));
      tr.appendChild(res);
      tbl.appendChild(tr);

      // Row 11 Homework
      tr = document.createElement('tr');
      tr.appendChild(td(2,'left-label','HOMEWORK'));
      const hw = td(12); setHTML(hw, escapeToHTML(week.homework));
      tr.appendChild(hw);
      tbl.appendChild(tr);

      return tbl;
    }

    function render(){
      const root = document.getElementById('doc');
      root.innerHTML = '';

      for(const g of GRADES){
        for(const week of g.weeks){
          const page = document.createElement('div');
          page.className = 'print-page';
          page.dataset.grade = g.grade;
          page.appendChild(buildPlanTable(g, week));
          root.appendChild(page);
        }
      }

      clearGradePrintFilter();
      runTests();
    }

    // -------------------------
    // PRINT HELPERS
    // -------------------------

    function safePrint(){
      requestAnimationFrame(() => {
        requestAnimationFrame(() => window.print());
      });
    }

    function applyGradePrintFilter(gradeName){
      document.body.classList.add('print-grade-active');
      const pages = document.querySelectorAll('.print-page');
      for(const p of pages){
        if(p.dataset.grade === gradeName) p.classList.add('print-grade-show');
        else p.classList.remove('print-grade-show');
      }
    }

    function clearGradePrintFilter(){
      document.body.classList.remove('print-grade-active');
      const pages = document.querySelectorAll('.print-page');
      for(const p of pages){ p.classList.remove('print-grade-show'); }
    }

    function printAll(){
      clearGradePrintFilter();
      safePrint();
    }

    function downloadPDFAll(){
      clearGradePrintFilter();
      safePrint();
    }

    function downloadPDFGrade(gradeName){
      applyGradePrintFilter(gradeName);
      safePrint();
      setTimeout(clearGradePrintFilter, 400);
    }

    // -------------------------
    // XLSX EXPORT (workbook per grade, sheet per week)
    // -------------------------

    function getLogoExtension(){
      const f = String(LOGO_FILE || '').toLowerCase().trim();
      if(f.endsWith('.png')) return 'png';
      if(f.endsWith('.jpg') || f.endsWith('.jpeg')) return 'jpeg';
      return null;
    }

    async function fetchLogoArrayBuffer(){
      const ext = getLogoExtension();
      if(!ext) return null;
      try{
        const res = await fetch(logoURL(true), { cache: 'no-store' });
        if(!res.ok) return null;
        return await res.arrayBuffer();
      }catch(e){
        return null;
      }
    }

    function setBorder(cell){
      cell.border = { top:{style:'medium'}, left:{style:'medium'}, bottom:{style:'medium'}, right:{style:'medium'} };
    }
    function fill(cell, argb){
      cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:argb} };
    }
    function font(cell, bold, size, argb){
      cell.font = { name:'Arial', size:size, bold:!!bold, color:{argb:argb || 'FF000000'} };
    }
    function align(cell, h, v){
      cell.alignment = { horizontal:h, vertical:v, wrapText:true };
    }

    function writeTemplate(ws){
      const merges = [
        'A1:D1','E1:J1','K1:N1',
        'A2:B2','C2:D2','E2:J2','K2:L2','M2:N2',
        'A3:B3','C3:D3','E3:N3',
        'A4:B4','C4:G4','H4:N4',
        'A5:A8',
        'C5:G5','H5:N5',
        'C6:G6','H6:N6',
        'C7:G7','H7:N7',
        'C8:G8','H8:N8',
        'A9:B9','C9:N9',
        'A10:B10','C10:N10',
        'A11:B11','C11:N11'
      ];
      for(const m of merges){ ws.mergeCells(m); }

      for(let r=1;r<=11;r++){
        for(let c=1;c<=14;c++){
          const cell = ws.getCell(r,c);
          setBorder(cell);
          font(cell,false,11);
          align(cell,'left','top');
        }
      }

      ws.getRow(1).height = 42;
      ws.getRow(2).height = 20;
      ws.getRow(3).height = 18;
      ws.getRow(4).height = 18;
      ws.getRow(5).height = 20;
      ws.getRow(6).height = 45;
      ws.getRow(7).height = 70;
      ws.getRow(8).height = 45;
      ws.getRow(9).height = 22;
      ws.getRow(10).height = 22;
      ws.getRow(11).height = 22;

      for(let c=1;c<=14;c++){ ws.getColumn(c).width = 12; }

      const nl = String.fromCharCode(10);

      ws.getCell('A1').value = 'INTERMEDIATE PHASE' + nl + 'WEEKLY LESSON PLAN';
      font(ws.getCell('A1'),true,12);
      align(ws.getCell('A1'),'left','middle');

      ws.getCell('E1').value = 'DISA PRIMARY SCHOOL';
      font(ws.getCell('E1'),true,14);
      align(ws.getCell('E1'),'center','middle');

      ws.getCell('K1').value = 'SUBJECT:';
      font(ws.getCell('K1'),true,12);
      align(ws.getCell('K1'),'right','middle');

      const greenCells = ['A2','C2','E2','K2','M2'];
      for(const addr of greenCells){
        const cell = ws.getCell(addr);
        fill(cell,'FF93C47D');
        font(cell,true,12,'FFFFFFFF');
        align(cell,'center','middle');
      }
      ws.getCell('A2').value = 'Term:';
      ws.getCell('C2').value = 'Week:';
      ws.getCell('E2').value = 'Date:';
      ws.getCell('K2').value = 'Grade:';
      ws.getCell('M2').value = 'Teacher:';

      ws.getCell('C4').value = 'LESSON 1';
      ws.getCell('H4').value = 'LESSON 2';
      for(const addr of ['C4','H4']){ font(ws.getCell(addr),true,12); align(ws.getCell(addr),'center','middle'); }

      ws.getCell('A5').value = 'TEACHING AND' + nl + 'LEARNING' + nl + 'ACTIVITIES';
      font(ws.getCell('A5'),true,11);
      align(ws.getCell('A5'),'center','middle');

      ws.getCell('B5').value = 'CAPS Topic';
      ws.getCell('B6').value = 'Introduction';
      ws.getCell('B7').value = 'Activities';
      ws.getCell('B8').value = 'Check for' + nl + 'understanding';
      for(const addr of ['B5','B6','B7','B8']){ font(ws.getCell(addr),true,11); align(ws.getCell(addr),'center','middle'); }

      fill(ws.getCell('C5'),'FFE6E6E6');
      fill(ws.getCell('H5'),'FFE6E6E6');

      ws.getCell('A9').value  = 'INTEGRATION';
      ws.getCell('A10').value = 'RESOURCES';
      ws.getCell('A11').value = 'HOMEWORK';
      for(const addr of ['A9','A10','A11']){ font(ws.getCell(addr),true,11); align(ws.getCell(addr),'center','middle'); }
    }

    async function buildGradeWorkbook(gradeName){
      if(!window.ExcelJS) throw new Error('ExcelJS not loaded');

      const grade = GRADES.find(g => g.grade === gradeName);
      if(!grade) throw new Error('Unknown grade');

      const wb = new ExcelJS.Workbook();
      wb.creator = TEACHER;

      const logoBuf = await fetchLogoArrayBuffer();
      let logoId = null;
      const ext = getLogoExtension();
      if(logoBuf && ext){
        logoId = wb.addImage({ buffer: logoBuf, extension: ext });
      }

      for(const week of grade.weeks){
        const ws = wb.addWorksheet('Week ' + week.w, {
          pageSetup: { paperSize: 9, orientation: 'landscape', fitToPage: true, fitToWidth: 1, fitToHeight: 1 }
        });

        writeTemplate(ws);

        ws.getCell('K1').value = 'SUBJECT: ' + grade.subject;

        ws.getCell('A3').value = TERM_LABEL;
        ws.getCell('C3').value = 'Week ' + week.w;
        ws.getCell('E3').value = week.dates;
        ws.getCell('K3').value = grade.grade;
        ws.getCell('M3').value = TEACHER;

        const nl = String.fromCharCode(10);
        ws.getCell('C5').value = grade.capsTopic + nl + grade.grade + ' — ' + grade.timetable;
        ws.getCell('H5').value = grade.capsTopic + nl + grade.grade + ' — ' + grade.timetable;

        ws.getCell('C6').value = week.lesson1.intro;
        ws.getCell('C7').value = week.lesson1.activities;
        ws.getCell('C8').value = week.lesson1.check;

        ws.getCell('H6').value = week.lesson2.intro;
        ws.getCell('H7').value = week.lesson2.activities;
        ws.getCell('H8').value = week.lesson2.check;

        ws.getCell('C9').value = week.integration;
        ws.getCell('C10').value = week.resources;
        ws.getCell('C11').value = week.homework;

        for(const addr of ['C5','H5','C6','C7','C8','H6','H7','H8','C9','C10','C11']){
          align(ws.getCell(addr),'left','top');
        }

        if(logoId){
          ws.addImage(logoId, { tl: { col: 6.2, row: 0.15 }, ext: { width: 120, height: 55 } });
        }
      }

      return wb;
    }

    async function downloadXLSXGrade(gradeName){
      try{
        // Quick visibility check to help debug missing logo in downloads
        const ext = getLogoExtension();
        if(!ext){
          console.warn('Logo skipped: LOGO_FILE is not a supported image type:', LOGO_FILE);
        }else{
          const testRes = await fetch(logoURL(true), { cache: 'no-store' }).catch(() => null);
          if(!testRes || !testRes.ok){
            console.warn('Logo fetch failed for XLSX export. Check file path/case and repo location:', logoURL(false));
          }
        }

        const wb = await buildGradeWorkbook(gradeName);
        const buf = await wb.xlsx.writeBuffer();
        const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'DISA_' + gradeName.split(' ').join('_') + '_Term1_Weekly_Lesson_Plans.xlsx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }catch(err){
        console.error(err);
        alert('XLSX download failed. Open the console for details.');
      }
    }

    // -------------------------
    // TESTS
    // -------------------------

    function runTests(){
      const t1 = escapeToHTML('a\\nb');
      console.assert(t1.indexOf('<br>') !== -1, 'escapeToHTML should convert newlines');

      const t2 = escapeToHTML('quote " test');
      console.assert(t2.indexOf('&quot;') !== -1, 'escapeToHTML should escape double quotes');

      const t3 = escapeToHTML('x & y');
      console.assert(t3.indexOf('&amp;') !== -1, 'escapeToHTML should escape ampersands');

      const t4 = escapeToHTML('<tag>');
      console.assert(t4.indexOf('&lt;tag&gt;') !== -1, 'escapeToHTML should escape angle brackets');

      const t5 = escapeToHTML("O'Reilly");
      console.assert(t5.indexOf('&#39;') !== -1, 'escapeToHTML should escape apostrophes');

      console.assert(getLogoExtension() === 'png', 'PNG logo should be detected as png');

      const g7 = GRADES.find(g => g.grade === 'Grade 7');
      const techCount = g7.weeks.slice(0,9).filter(w => String(w.lesson1.activities).indexOf('TECH (35%') !== -1).length;
      console.assert(techCount === 9, 'Grade 7 should schedule 9 Technology lessons (≈35%)');

      // Extra: ensure no literal newlines exist inside JS strings in key places
      console.assert(String(escapeToHTML).indexOf("split('\n')") !== -1, 'escapeToHTML should use \\n splitting');
    }

    // Initial render
    render();
  </script>
</body>
</html>
